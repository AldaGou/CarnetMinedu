import React, { useRef, useState } from "react";
import { Button } from "@/components/ui/button";
import Cropper from "react-easy-crop";
import { getCroppedImg } from "./utils/cropImage";

const ImageProcessor = () => {
  const fileInputRef = useRef(null);
  const [imageSrc, setImageSrc] = useState(null);
  const [croppedAreaPixels, setCroppedAreaPixels] = useState(null);
  const [crop, setCrop] = useState({ x: 0, y: 0 });
  const [zoom, setZoom] = useState(1);

  const onFileChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = () => setImageSrc(reader.result);
      reader.readAsDataURL(file);
    }
  };

  const onCropComplete = (croppedArea, croppedAreaPixels) => {
    setCroppedAreaPixels(croppedAreaPixels);
  };

  const processImage = async () => {
    if (!croppedAreaPixels || !imageSrc) return;

    const croppedImage = await getCroppedImg(imageSrc, croppedAreaPixels, 300);
    const blob = await fetch(croppedImage).then((res) => res.blob());

    if (blob.size > 50 * 1024) {
      alert("La imagen procesada excede los 50KB. Prueba recortando más o reduciendo detalles.");
      return;
    }

    const downloadLink = document.createElement("a");
    downloadLink.href = croppedImage;
    downloadLink.download = "processed-image.png";
    downloadLink.click();
  };

  return (
    <div className="p-4">
      <h1 className="text-xl font-bold mb-4">Procesador de Imágenes</h1>
      <input
        type="file"
        accept="image/*"
        ref={fileInputRef}
        className="hidden"
        onChange={onFileChange}
      />
      <Button onClick={() => fileInputRef.current.click()}>Cargar Imagen</Button>

      {imageSrc && (
        <div className="relative mt-4" style={{ width: 240, height: 288 }}>
          <Cropper
            image={imageSrc}
            crop={crop}
            zoom={zoom}
            aspect={240 / 288}
            onCropChange={setCrop}
            onZoomChange={setZoom}
            onCropComplete={onCropComplete}
          />
        </div>
      )}

      <Button
        onClick={processImage}
        disabled={!imageSrc}
        className="mt-4"
      >
        Procesar Imagen
      </Button>
    </div>
  );
};

export default ImageProcessor;

// utils/cropImage.js
export const getCroppedImg = (imageSrc, crop, dpi = 300) => {
  const canvas = document.createElement("canvas");
  const scale = dpi / 96;

  canvas.width = crop.width * scale;
  canvas.height = crop.height * scale;
  const ctx = canvas.getContext("2d");

  const img = new Image();
  img.src = imageSrc;

  return new Promise((resolve) => {
    img.onload = () => {
      ctx.drawImage(
        img,
        crop.x * scale,
        crop.y * scale,
        crop.width * scale,
        crop.height * scale,
        0,
        0,
        canvas.width,
        canvas.height
      );

      canvas.toBlob(
        (blob) => {
          resolve(URL.createObjectURL(blob));
        },
        "image/png",
        1
      );
    };
  });
};
